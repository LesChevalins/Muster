<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr">

	<head>
		<link media="all" type="text/css" rel="stylesheet" href="css/map.css">
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<!-- Elément Google Maps indiquant que la carte doit être affiché en plein écran et
		qu'elle ne peut pas être redimensionnée par l'utilisateur -->
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<!-- Inclusion de l'API Google MAPS -->
		<!-- Le paramètre "sensor" indique si cette application utilise détecteur pour déterminer la position de l'utilisateur -->
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdzLI8IgAA83XT05Q1JyHJevB4vENjtx8&callback=initMap"></script>
		<script type="text/javascript">
			function initialiser() {
				var latlng = new google.maps.LatLng(45.764043, 	4.835658999999964);
				//objet contenant des propriétés avec des identificateurs prédéfinis dans Google Maps permettant
				//de définir des options d'affichage de notre carte
				var options = {
					center: latlng,
					zoom: 15,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};

				//constructeur de la carte qui prend en paramêtre le conteneur HTML
				//dans lequel la carte doit s'afficher et les options
				var carte = new google.maps.Map(document.getElementById("carte"), options);
			}
		</script>

		<script>
			function initialiser() {
				var latlng = new google.maps.LatLng(45.764043, 	4.835658999999964);

				var options = {
					center: latlng,
					zoom: 13,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};

				var carte = new google.maps.Map(document.getElementById("carte"), options);

/****************Nouveau code****************/

	//création des design markers

	//création du marqueur
	var marqueur_add = new google.maps.Marker({
		position: new google.maps.LatLng(45.777283, 4.83475610000005),
		icon: 'pics/marker_add.png',
		map: carte
	});

	var marqueur_premium = [];
	var marqueur_soft = [];
	var events = [];
	var date = new Date().toJSON().slice(0,10);

	get_events();

	function get_events(){
		var xhttp_events = new XMLHttpRequest();
		xhttp_events.open("GET", "arrestdb/index.php/eachother_event/", true);
		xhttp_events.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		    events = JSON.parse(xhttp_events.responseText);
				complete_events();
		  }
		};
		xhttp_events.send();
	}

	function complete_events(){
		for(i = 0; i < events.length; i++){
			var event = events[i];
			get_location(event["location_id"], i);
			get_user(event["user_id"], i);
		}
	}

	function get_location(location_id, i){
		var xhttp_location = new XMLHttpRequest();
		xhttp_location.open("GET", "arrestdb/index.php/eachother_location/location_id/" + location_id, true);
		xhttp_location.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		    var location = JSON.parse(xhttp_location.responseText);
				delete events[i]["location_id"];
				events[i]["location"] = location[0];
		  }
		};
		xhttp_location.send();
	}

	function get_user(user_id, i){
		var xhttp_user = new XMLHttpRequest();
		xhttp_user.open("GET", "arrestdb/index.php/eachother_user/user_id/" + user_id, true);
		xhttp_user.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		    var user = JSON.parse(xhttp_user.responseText);
				delete events[i]["user_id"];
				events[i]["user"] = user[0];
				display_event(i);
		  }
		};
		xhttp_user.send();
	}

	function display_event(i){
			var event = events[i];
			if(event["user"]["user_subscription_end_date"] != undefined){
				event["user"]["user_subscription_end_date"] = event["user"]["user_subscription_end_date"].substring(0,10);
				if(date < event["user"]["user_subscription_end_date"]){
					display_event_premium(i);
				}
				else{
					display_event_soft(i);
				}
			}
			else{
				display_event_soft(i);
			}
	}

	function display_event_premium(i){
		var event = events[i];
		var location = event["location"];
		if(location != undefined){
			marqueur_premium[i] = new google.maps.Marker({
				position: new google.maps.LatLng(location["location_latitude"], location["location_longitude"]),
				icon: 'pics/marker_premium.png',
				map: carte
			});
			google.maps.event.addListener(marqueur_premium[i], 'click', function(){
				var event = events[i];
				var pop_up = document.getElementById('pop_premium');
				pop_up.style.display = "block";
			});
		}
	}

	function display_event_soft(i){
		var event = events[i];
		var location = event["location"];
		if(location != undefined){
			marqueur_soft[i] = new google.maps.Marker({
				position: new google.maps.LatLng(location["location_latitude"], location["location_longitude"]),
				icon: 'pics/marker_soft.png',
				map: carte
			});
			google.maps.event.addListener(marqueur_soft[i], 'click', function(){
					var event = events[i];
					var pop_up = document.getElementById('pop_soft');
					pop_up.style.display = "block";

					pop_up.getElementsByClassName("pop_title")[0].innerHTML = event["event_name"];
					pop_up.getElementsByClassName("pop_desc")[0].innerHTML = event["event_description"];
					pop_up.getElementsByClassName("pop_address")[0].innerHTML = event["location"]["location_address"] + ", " + event["location"]["location_city"];
					var date_split = event["event_date"].split(" ")[0].split("-");
					var date = date_split[2] + " / " + date_split[1] + " / " + date_split[0];
					pop_up.getElementsByClassName("pop_date")[0].innerHTML = date;
					var time_split = event["event_date"].split(" ")[1].split(":");
					var time = time_split[0] + "H" + time_split[1];
					pop_up.getElementsByClassName("pop_time")[0].innerHTML = time;
					var phone_split = event["user"]["user_phone"].replace(/(.{2})/g,"$1 ");
					pop_up.getElementsByClassName("pop_phone")[0].innerHTML = phone_split;
					pop_up.getElementsByClassName("pic-profil")[0].src = event["user"]["user_picture"];
					pop_up.getElementsByClassName("pop_username")[0].innerHTML = event["user"]["user_firstname"] + " " + event["user"]["user_lastname"];
					pop_up.getElementsByClassName("pop_userdesc")[0].innerHTML = event["user"]["user_description"];
					pop_up.getElementsByClassName("pop_username")[1].innerHTML = event["user"]["user_firstname"] + " " + event["user"]["user_lastname"];
			});
		}
	}

	marqueur_add.setDraggable(true);

	google.maps.event.addListener(marqueur_add, 'dragend', function(event) {
	//message d'alerte affichant la nouvelle position du marqueur
	alert("La nouvelle coordonnée du marqueur est : "+event.latLng);
	});

	}

	/***********************Custom map marker************************/


		</script>

	</head>
	<body onload="initialiser()">
		<div id="carte" style="width:100%; height:100%; position:absolute; top:0; left:0;"></div>

		<nav class="menu" tabindex="0">
			<div class="smartphone-menu-trigger"></div>
  			<header class="avatar">
					<img src="https://s3.amazonaws.com/uifaces/faces/twitter/kolage/128.jpg" />
    			<h2>John D.</h2>
  			</header>
				<ul>
    			<li tabindex="0" class=""><span>Dashboard</span></li>
    			<li tabindex="0" class="icon-customers"><span>Customers</span></li>
    			<li tabindex="0" class="icon-users"><span>Users</span></li>
    			<li tabindex="0" class="icon-settings"><span>Settings</span></li>
  			</ul>
		</nav>

		<div id="pop_soft" style="display:none;">
			<img src="pics/close_soft.png" class="close" onclick="document.getElementById('pop_soft').style.display='none';">
			<div id="soft_event">
				<div class="img_event"></div>
				<div class="desc_event">
					<h1 class="pop_title" style="color:#03EBA6;">Titre de l'annonce</h1>
					<p class="pop_desc">Description de l'annonce ->>> Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
					<ul>
						<li><h2><img src="pics/marker_soft.png"> <span class="pop_address">On fout l'adresse</span></h2></li>
						<li><img src=""><h2><span style="color:#03EBA6;">Le</span> <span class="pop_date">20 / 09 / 2016</span> <span style="color:#03EBA6;">à</span> <span class="pop_time">20H00</span></h2></li>
					</ul>
					<h2 style="text-align:center;"><img src="pics/phone_soft.png"> <span class="pop_phone">+ 33 6 56 65 45 43</span></h2>
				</div>
				<div class="profiler">
					<img src="https://s3.amazonaws.com/uifaces/faces/twitter/kolage/128.jpg" class="pic-profil">
					<h2 class="pop_username">Nom de l'utilisateur</h2>
					<p class="pop_userdesc">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
				</div>
				<div class="comment">
					<h1 style="color:#03EBA6;">Les avis sur <span class="pop_username">"Nom de l'utilisateur"</span></h1>
					<span>
						<ul class="comment-rate">
							<li>Quelques stars</li>
							<li>"Super ce mec, activité au top !"</li>
						</ul>
					</span>
				</div>
			</div>
	</div>


	<div id="pop_premium" style="display:none;">
		<img src="pics/close_premium.png" class="close" onclick="document.getElementById('pop_premium').style.display='none';">
		<div id="soft_event">
			<div class="img_event"></div>
			<div class="desc_event">
				<h1 class="pop_title" style="color:#2FAACE;">Titre de l'annonce</h1>
				<p class="pop_desc">Description de l'annonce ->>> Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
				<ul>
					<li><h2><img src="pics/marker_premium.png"> <span class="pop_address">On fout l'adresse</span></h2></li>
					<li><img src=""><h2><span style="color:#2FAACE;">Le</span> <span class="pop_date">20 / 09 / 2016</span> <span style="color:#2FAACE;">à</span> <span class="pop_time">20H00</span></h2></li>
				</ul>
				<h2 style="text-align:center;"><img src="pics/phone_premium.png"> <span class="pop_phone">+ 33 6 56 65 45 43</span></h2>
			</div>
			<div class="profiler">
				<img src="https://s3.amazonaws.com/uifaces/faces/twitter/kolage/128.jpg" class="pic-profil">
				<h2 class="pop_username">Nom de l'utilisateur</h2>
				<p class="pop_userdesc">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
			</div>
			<div class="comment">
				<h1 style="color:#2FAACE;">Les avis sur <span class="pop_username">"Nom de l'utilisateur"</span></h1>
				<span>
					<ul class="comment-rate">
						<li>Quelques stars</li>
						<li>"Super ce mec, activité au top !"</li>
					</ul>
				</span>
			</div>
		</div>
</div>

	</body>
</html>
