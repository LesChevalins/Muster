<html  class="overf" xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr">

	<head>
		<meta charset="utf-8">

		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">


		    <link rel="icon" type="image/png" href="pics/logo.png" />
		    <title>Lucky</title>

		<!-- Bootstrap -->
		<link rel="stylesheet" type="text/css" href="plugins/bootstrap/css/bootstrap.min.css" >

		<!-- Ionicons -->
		<link rel="stylesheet" type="text/css" href="../code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">

		<!-- le css -->
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<link rel="stylesheet" type="text/css" href="css/misc.css">
		<link rel="stylesheet" type="text/css" href="css/addcss.css">
		<link rel="stylesheet" type="text/css" href="plugins/sweetalert2/sweetalert2.min.css">

		<!-- Slick -->
		<link rel="stylesheet" type="text/css" href="plugins/slick/slick.css"/>
		<link rel="stylesheet" type="text/css" href="plugins/slick/slick-theme.css"/>
		<link media="all" type="text/css" rel="stylesheet" href="css/map.css">
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<!-- Elément Google Maps indiquant que la carte doit être affiché en plein écran et
		qu'elle ne peut pas être redimensionnée par l'utilisateur -->
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<!-- Inclusion de l'API Google MAPS -->
		<!-- Le paramètre "sensor" indique si cette application utilise détecteur pour déterminer la position de l'utilisateur -->
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdzLI8IgAA83XT05Q1JyHJevB4vENjtx8&callback=initMap"></script>
		<script type="text/javascript">
			function initialiser() {
				var latlng = new google.maps.LatLng(45.764043, 	4.835658999999964);
				//objet contenant des propriétés avec des identificateurs prédéfinis dans Google Maps permettant
				//de définir des options d'affichage de notre carte
				var options = {
					center: latlng,
					zoom: 15,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};

				//constructeur de la carte qui prend en paramêtre le conteneur HTML
				//dans lequel la carte doit s'afficher et les options
				var carte = new google.maps.Map(document.getElementById("carte"), options);
			}
		</script>

		<script>

		var marqueur_premium = [];
		var marqueur_soft = [];
		var events = [];
		var date = new Date().toJSON().slice(0,10);
		var rates = [];

			function initialiser() {
				var latlng = new google.maps.LatLng(45.764043, 	4.835658999999964);

				var options = {
					center: latlng,
					zoom: 13,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};

				var carte = new google.maps.Map(document.getElementById("carte"), options);

/****************Nouveau code****************/

	//création des design markers

	//création du marqueur
	var marqueur_add = new google.maps.Marker({
		position: new google.maps.LatLng(45.777283, 4.83475610000005),
		icon: 'pics/marker_add.png',
		map: carte
	});

	get_profile();
	get_events();

	function get_profile(){
		var xhttp_profile = new XMLHttpRequest();
    xhttp_profile.open("GET", "http://163.172.188.241/Muster/profil.php", true);
    xhttp_profile.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        profile = JSON.parse(xhttp_profile.responseText);

        div = document.getElementsByClassName('avatar')[0];
        div.getElementsByTagName('img')[0].src = profile["user_picture"];
        div.getElementsByTagName('h2')[0].innerHTML = profile["user_firstname"] + " " + profile["user_lastname"];
      }
    };
    xhttp_profile.send();
	}

	function get_events(){
		var xhttp_events = new XMLHttpRequest();
		xhttp_events.open("GET", "http://163.172.188.241/arrestdb/index.php/eachother_event/", true);
		xhttp_events.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		    events = JSON.parse(xhttp_events.responseText);
				complete_events();
		  }
		};
		xhttp_events.send();
	}

	function complete_events(){
		for(i = 0; i < events.length; i++){
			var event = events[i];
			get_location(event["location_id"], i);
			get_user(event["user_id"], i);
			// get_category(event["category_id"], i);
		}
	}

	function get_location(location_id, i){
		var xhttp_location = new XMLHttpRequest();
		xhttp_location.open("GET", "http://163.172.188.241/arrestdb/index.php/eachother_location/location_id/" + location_id, true);
		xhttp_location.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		    var location = JSON.parse(xhttp_location.responseText);
				delete events[i]["location_id"];
				events[i]["location"] = location[0];
		  }
		};
		xhttp_location.send();
	}

	function get_user(user_id, i){
		var xhttp_user = new XMLHttpRequest();
		xhttp_user.open("GET", "http://163.172.188.241/arrestdb/index.php/eachother_user/user_id/" + user_id, true);
		xhttp_user.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		    var user = JSON.parse(xhttp_user.responseText);
				delete events[i]["user_id"];
				events[i]["user"] = user[0];
				display_event(i);
		  }
		};
		xhttp_user.send();
	}

	// function get_category(category_id, i){
	// 	var xhttp_category = new XMLHttpRequest();
	// 	xhttp_category.open("GET", "http://163.172.188.241/arrestdb/index.php/eachother_category/category_id/" + category_id, true);
	// 	xhttp_category.onreadystatechange = function() {
	//   if (this.readyState == 4 && this.status == 200) {
	// 	    var category = JSON.parse(xhttp_category.responseText);
	// 			delete events[i]["category_id"];
	// 			events[i]["category"] = category[0];
	// 			display_event(i);
	//
	// 			if(document.getElementById("category_" + category_id) == undefined){
	// 				document.getElementsByClassName("categories-list")[0].innerHTML += "<li onclick='toggle_category(this)' class='icon-checked' id='category_" + category[0]["category_id"] + "'><span>" + category[0]["category_name"] + "</span></li>";
	// 			}
	// 	  }
	// 	};
	// 	xhttp_category.send();
	// }

	function display_event(i){
			var event = events[i];
			if(event["user"]["user_subscription_end_date"] != undefined){
				event["user"]["user_subscription_end_date"] = event["user"]["user_subscription_end_date"].substring(0,10);
				if(date < event["user"]["user_subscription_end_date"]){
					display_event_premium(i);
				}
				else{
					display_event_soft(i);
				}
			}
			else{
				display_event_soft(i);
			}
	}

	function display_event_premium(i){
		var event = events[i];
		var location = event["location"];
		if(location != undefined){
			marqueur_premium[i] = new google.maps.Marker({
				position: new google.maps.LatLng(location["location_latitude"], location["location_longitude"]),
				icon: 'pics/marker_premium.png',
				map: carte
			});
			// marqueur_premium[i].set("class", "category_" + event["category"]["category_id"]);
			google.maps.event.addListener(marqueur_premium[i], 'click', function(){
					var event = events[i];
					var user = event["user"];
					var pop_up = document.getElementById('pop_premium');
					pop_up.style.display = "block";

					pop_up.getElementsByClassName("pop_title")[0].innerHTML = event["event_name"];
					pop_up.getElementsByClassName("pop_desc")[0].innerHTML = event["event_description"];
					pop_up.getElementsByClassName("pop_address")[0].innerHTML = event["location"]["location_address"] + ", " + event["location"]["location_city"];
					var date_split = event["event_date"].split(" ")[0].split("-");
					var date = date_split[2] + " / " + date_split[1] + " / " + date_split[0];
					pop_up.getElementsByClassName("pop_date")[0].innerHTML = date;
					var time_split = event["event_date"].split(" ")[1].split(":");
					var time = time_split[0] + "H" + time_split[1];
					pop_up.getElementsByClassName("pop_time")[0].innerHTML = time;
					var phone_split = user["user_phone"];
					pop_up.getElementsByClassName("pop_phone")[0].innerHTML = phone_split;
					pop_up.getElementsByClassName("pic-profil")[0].src = user["user_picture"];
					pop_up.getElementsByClassName("pop_username")[0].innerHTML = user["user_firstname"] + " " + user["user_lastname"];
					pop_up.getElementsByClassName("pop_userdesc")[0].innerHTML = user["user_description"];
					pop_up.getElementsByClassName("pop_username")[1].innerHTML = user["user_firstname"] + " " + user["user_lastname"];

					var xhttp_rate = new XMLHttpRequest();
					xhttp_rate.open("GET", "http://163.172.188.241/arrestdb/index.php/eachother_rate/rated_id/" + user["user_id"], true);
					xhttp_rate.onreadystatechange = function() {
				  if (this.readyState == 4 && this.status == 200) {
					    rates = JSON.parse(xhttp_rate.responseText);

							for(j = 0; j < rates.length; j++){
								var note_id = rates[j]["note_id"];
								pop_up.getElementsByClassName("pop_notes")[0].innerHTML = "";

								var xhttp_note = new XMLHttpRequest();
								xhttp_note.open("GET", "http://163.172.188.241/arrestdb/index.php/eachother_note/note_id/" + note_id, true);
								xhttp_note.onreadystatechange = function() {
							  if (this.readyState == 4 && this.status == 200) {
										var note = JSON.parse(xhttp_note.responseText)[0];

										pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<ul class='comment-rate'>";
										for(k = 5; k >= 1; k--){
											if(k >= note["note_value"]){
												pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<span style='color: gold;'>&#9733;<span>";
											}
											else{
												pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<span>&#9734;</span>";
											}
										}
										pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<span style='font-weight: bold; padding-left: 5px;'>" + note["note_title"] + "</span><br/>";
										pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<span>" + note["note_description"] + "</span>"
										pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "</ul>";
								  }
								};
								xhttp_note.send();
							}
					  }
					};
					xhttp_rate.send();
			});
		}
	}

	function display_event_soft(i){
		var event = events[i];
		var location = event["location"];
		if(location != undefined){
			marqueur_soft[i] = new google.maps.Marker({
				position: new google.maps.LatLng(location["location_latitude"], location["location_longitude"]),
				icon: 'pics/marker_soft.png',
				map: carte
			});
			// marqueur_soft[i].set("class", "category_" + event["category"]["category_id"]);
			google.maps.event.addListener(marqueur_soft[i], 'click', function(){
					var event = events[i];
					var user = event["user"];
					var pop_up = document.getElementById('pop_soft');
					pop_up.style.display = "block";

					pop_up.getElementsByClassName("pop_title")[0].innerHTML = event["event_name"];
					pop_up.getElementsByClassName("pop_desc")[0].innerHTML = event["event_description"];
					pop_up.getElementsByClassName("pop_address")[0].innerHTML = event["location"]["location_address"] + ", " + event["location"]["location_city"];
					var date_split = event["event_date"].split(" ")[0].split("-");
					var date = date_split[2] + " / " + date_split[1] + " / " + date_split[0];
					pop_up.getElementsByClassName("pop_date")[0].innerHTML = date;
					var time_split = event["event_date"].split(" ")[1].split(":");
					var time = time_split[0] + "H" + time_split[1];
					pop_up.getElementsByClassName("pop_time")[0].innerHTML = time;
					var phone_split = user["user_phone"];
					pop_up.getElementsByClassName("pop_phone")[0].innerHTML = phone_split;
					pop_up.getElementsByClassName("pic-profil")[0].src = user["user_picture"];
					pop_up.getElementsByClassName("pop_username")[0].innerHTML = user["user_firstname"] + " " + user["user_lastname"];
					pop_up.getElementsByClassName("pop_userdesc")[0].innerHTML = user["user_description"];
					pop_up.getElementsByClassName("pop_username")[1].innerHTML = user["user_firstname"] + " " + user["user_lastname"];

					var xhttp_rate = new XMLHttpRequest();
					xhttp_rate.open("GET", "http://163.172.188.241/arrestdb/index.php/eachother_rate/rated_id/" + user["user_id"], true);
					xhttp_rate.onreadystatechange = function() {
				  if (this.readyState == 4 && this.status == 200) {
					    rates = JSON.parse(xhttp_rate.responseText);

							for(j = 0; j < rates.length; j++){
								var note_id = rates[j]["note_id"];
								pop_up.getElementsByClassName("pop_notes")[0].innerHTML = "";

								var xhttp_note = new XMLHttpRequest();
								xhttp_note.open("GET", "http://163.172.188.241/arrestdb/index.php/eachother_note/note_id/" + note_id, true);
								xhttp_note.onreadystatechange = function() {
							  if (this.readyState == 4 && this.status == 200) {
										var note = JSON.parse(xhttp_note.responseText)[0];

										pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<ul class='comment-rate'>";
										for(k = 5; k >= 1; k--){
											if(k >= note["note_value"]){
												pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<span style='color: gold;'>&#9733;<span>";
											}
											else{
												pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<span>&#9734;</span>";
											}
										}
										pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<span style='font-weight: bold; padding-left: 5px;'>" + note["note_title"] + "</span><br/>";
										pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "<span>" + note["note_description"] + "</span>"
										pop_up.getElementsByClassName("pop_notes")[0].innerHTML += "</ul>";
								  }
								};
								xhttp_note.send();
							}
					  }
					};
					xhttp_rate.send();
			});
		}
	}

	marqueur_add.setDraggable(true);

	google.maps.event.addListener(marqueur_add, 'dragend', function(event) {
	//message d'alerte affichant la nouvelle position du marqueur7
	document.getElementById('new-event').style.display='block';
	});

	}

	// function toggle_category(cat){
	// 	if(cat.getAttribute("class") == "icon-checked"){
	// 		cat.setAttribute("class", "");
	// 		for(e = 0; e < marqueur_soft.length; e++){
	// 			console.log(e)
	// 			console.log(marqueur_soft[e]);
	// 			if(marqueur_soft[e]["class"] == cat.id){
	// 				marqueur_soft[e].setVisible(false);
	// 			}
	// 		}
	// 		for(e = 0; e < marqueur_premium.length; e++){
	// 			if(marqueur_premium[e]["class"] == cat.id){
	// 				marqueur_premium[e].setVisible(false);
	// 			}
	// 		}
	// 	}
	// 	else{
	// 		cat.setAttribute("class", "icon-checked");
	// 		for(e = 0; e < marqueur_soft.length; e++){
	// 			if(marqueur_soft[e]["class"] == cat.id){
	// 				marqueur_soft[e].setVisible(true);
	// 			}
	// 		}
	// 		for(e = 0; e < marqueur_premium.length; e++){
	// 			if(marqueur_premium[e]["class"] == cat.id){
	// 				marqueur_premium[e].setVisible(true);
	// 			}
	// 		}
	// 	}
	// }

	/***********************Custom map marker************************/


		</script>

	</head>
	<body onload="initialiser()">
		<div id="carte" style="width:100%; height:100%; position:absolute; top:0; left:0;"></div>

		<nav class="menu" tabindex="0">
			<div class="smartphone-menu-trigger"></div>
  			<header class="avatar">
					<img src="" />
    			<h2></h2>
  			</header>
				<ul>
    			<li tabindex="0" class="icon-dashboard"><span>Retour</span></li>
    			<li tabindex="0" class="icon-customers" onclick="document.getElementById('new-event').style.display='block';"><span>Déposer une annonce</span></li>
    			<a href="profil.html" style="text-decoration:none;color:black;"><li tabindex="0" class="icon-users"><span>Mon profil</span></li></a>
					<div class="categories-list" style="margin-top: 25px"></div>
  			</ul>
		</nav>

		<div id="pop_soft" style="display:none;">
			<img src="pics/close_soft.png" class="close" onclick="document.getElementById('pop_soft').style.display='none';">
			<div id="soft_event">
				<div class="img_event"></div>
				<div class="desc_event">
					<h1 class="pop_title" style="color:#03EBA6;">Titre de l'annonce</h1>
					<p class="pop_desc">Description de l'annonce ->>> Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
					<ul>
						<li><h2><img src="pics/marker_soft.png"> <span class="pop_address">On fout l'adresse</span></h2></li>
						<li><img src=""><h2><span style="color:#03EBA6;">Le</span> <span class="pop_date">20 / 09 / 2016</span> <span style="color:#03EBA6;">à</span> <span class="pop_time">20H00</span></h2></li>
					</ul>
					<h2 style="text-align:center;"><img src="pics/phone_soft.png"> <span class="pop_phone">+ 33 6 56 65 45 43</span></h2>
				</div>
				<div class="profiler">
					<img src="https://s3.amazonaws.com/uifaces/faces/twitter/kolage/128.jpg" class="pic-profil">
					<h2 class="pop_username">Nom de l'utilisateur</h2>
					<p class="pop_userdesc">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
				</div>
				<div class="comment">
					<h1 style="color:#03EBA6;">Les avis sur <span class="pop_username">"Nom de l'utilisateur"</span></h1>
					<span style="inline-block" class="pop_notes">
						<ul class="comment-rate">
							<li>Quelques stars</li>
							<li>"Super ce mec, activité au top !"</li>
						</ul>
					</span>
				</div>
			</div>
	</div>


	<div id="pop_premium" style="display:none;">
		<img src="pics/close_premium.png" class="close" onclick="document.getElementById('pop_premium').style.display='none';">
		<div id="soft_event">
			<div class="img_event"></div>
			<div class="desc_event">
				<h1 class="pop_title" style="color:#2FAACE;">Titre de l'annonce</h1>
				<p class="pop_desc">Description de l'annonce ->>> Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
				<ul>
					<li><h2><img src="pics/marker_premium.png"> <span class="pop_address">On fout l'adresse</span></h2></li>
					<li><img src=""><h2><span style="color:#2FAACE;">Le</span> <span class="pop_date">20 / 09 / 2016</span> <span style="color:#2FAACE;">à</span> <span class="pop_time">20H00</span></h2></li>
				</ul>
				<h2 style="text-align:center;"><img src="pics/phone_premium.png"> <span class="pop_phone">+ 33 6 56 65 45 43</span></h2>
			</div>
			<div class="profiler">
				<img src="https://s3.amazonaws.com/uifaces/faces/twitter/kolage/128.jpg" class="pic-profil">
				<h2 class="pop_username">Nom de l'utilisateur</h2>
				<p class="pop_userdesc">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
			</div>
			<div class="comment">
				<h1 style="color:#2FAACE;">Les avis sur <span class="pop_username">"Nom de l'utilisateur"</span></h1>
				<span style="inline-block" class="pop_notes">
					<ul class="comment-rate">
						<li>Quelques stars</li>
						<li>"Super ce mec, activité au top !"</li>
					</ul>
				</span>
			</div>
		</div>
</div>

<div id="new-event" style="display:none;">
	<div id="form-new">
		<a onclick="document.getElementById('new-event').style.display = 'none'"><img src="pics/close-co.png" class="close-co"></a>
		<img src="pics/pic1.png">
		<form class="form-horizontal" id="add-event">
		  <div class="form-group">
		    <label for="inputEmail3" class="col-sm-2 control-label">Name</label>
		    <div class="col-sm-10">
		      <input type="text" class="form-control" id="inputName" placeholder="Name">
		    </div>
		  </div>
		  <div class="form-group">
		    <label for="inputPassword3" class="col-sm-2 control-label">Date</label>
		    <div class="col-sm-10">
		      <input type="Date" class="form-control" id="inputDate" placeholder="Date">
		    </div>
		  </div>
		  <div class="form-group">
		    <label for="inputPassword3" class="col-sm-2 control-label">Photo</label>
				<div class="col-sm-10">
		     <input type="file" name="icone" id="icone" class="form-control" /><br />
			 </div>
		  </div>
		  <div class="form-group">
		    <label for="icone">Description</label><br />
		    <textarea class="form-control" id="description" rows="3"></textarea>
		  </div>
		  <div class="form-group">
		    <label for="inputEmail3" class="col-sm-2 control-label">Adresse</label>
		    <div class="col-sm-10">
		      <input type="text" class="form-control" id="inputAdresse" placeholder="Adresse">
		    </div>
		  </div>
		  <div class="form-group">
		    <label for="inputEmail3" class="col-sm-2 control-label">City</label>
		    <div class="col-sm-10">
		      <input type="Date" class="form-control" id="inputCity" placeholder="Ville">
		    </div>
		  </div>
		  <div class="form-group">
		    <div class="col-sm-12">
		      <button type="submit" class="btn btn-default">Creer</button>
		    </div>
		  </div>
		</form>
	</div>
</div>

<script type="text/javascript">
  var add = document.getElementById('add-event');
  add.onsubmit = function(event){
    event.preventDefault();
		var name = document.getElementById('inputName').value;
    var date = document.getElementById('IinputDate').value;
    var photo = document.getElementById('icone').value;
		var description = document.getElementById('description').value;
		var adresse = document.getElementById('inputAdresse').value;
		var city = document.getElementById('inputCity').value;

    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'arrestdb/index.php/eachother_user', true);
    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhr.onload = function () {
      if (xhr.status === 200) {
      }
    };
    xhr.send("event_name=" + name + "&event_date" + date + "&event_picture" + photo + "&event_description" + description + "&address" + adresse);
  }
</script>

	</body>
</html>
